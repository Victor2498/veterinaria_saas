<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - {{ org.name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --border: rgba(255, 255, 255, 0.05);
            --sidebar-hover: rgba(99, 102, 241, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body.light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-dim: #64748b;
            --border: rgba(0, 0, 0, 0.05);
            --sidebar-hover: rgba(99, 102, 241, 0.05);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 1rem;
            border-radius: 12px;
            color: var(--text-dim);
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active,
        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--primary);
        }

        /* Theme Toggle */
        .theme-toggle {
            margin-top: 1rem;
            background: var(--sidebar-hover);
            padding: 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-dim);
            cursor: pointer;
            border: 1px solid var(--border);
        }

        .theme-toggle:hover {
            border-color: var(--primary-light);
            color: var(--text-main);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .tag {
            padding: 0.4rem 1rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tag-pro {
            background: linear-gradient(135deg, var(--secondary), #f43f5e);
            color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .tag-basic {
            background: var(--sidebar-hover);
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: var(--card-shadow);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--text-main);
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Table Section */
        .section-card {
            background: var(--card);
            border-radius: 24px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-dim);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn {
            background: var(--primary);
            color: white !important;
            padding: 0.6rem 1.2rem;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.3s;
            display: inline-block;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            outline: none;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">üêæ DogBot Admin</div>
        <a href="#" class="nav-item active" onclick="showSection('dashboard', this)">üìä Dashboard</a>
        <a href="#" class="nav-item" onclick="showSection('citas', this)">üóìÔ∏è Citas</a>
        <a href="#" class="nav-item" onclick="showSection('pacientes', this)">üê∂ Pacientes</a>

        <div style="margin-top: auto;">
            <a href="/admin/subscription" class="nav-item">üíé Suscripci√≥n</a>
            <a href="#" class="nav-item" onclick="openPasswordModal()">‚öôÔ∏è Configuraci√≥n</a>
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-text">Modo Claro</span>
                <span id="theme-icon">üåû</span>
            </div>
            <a href="/logout" class="nav-item" style="color: #f43f5e;">üö™ Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="main">
        <!-- Header Dynamic? No, header is global -->
        <div class="header">
            <div>
                <h1 style="font-size: 1.8rem;">Bienvenido, {{ username }}</h1>
                <p style="color: var(--text-dim)">Gestionando Cl√≠nica: <strong>{{ org.name }}</strong></p>
            </div>
            <div class="tag {% if org.plan_type == 'pro' %}tag-pro{% else %}tag-basic{% endif %}">
                Plan {{ org.plan_type }}
            </div>
        </div>

        <!-- SECTION: DASHBOARD -->
        <div id="section-dashboard" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Citas Totales</div>
                    <div class="stat-value">{{ all_appointments|length }}</div>
                    <div style="color: var(--success); font-size: 0.8rem;">‚Üë 12% este mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pacientes Activos</div>
                    <div class="stat-value">{{ patients_count }}</div>
                    <div style="color: var(--primary-light); font-size: 0.8rem;">Base de datos completa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">WhatsApp Status</div>
                    <div class="stat-value" style="color: var(--success); font-size: 1.2rem;">üü¢ Conectado</div>
                    <div style="color: var(--text-dim); font-size: 0.8rem;">Instancia: {{ org.evolution_instance }}
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h2>Citas Recientes (WhatsApp)</h2>
                    <a href="#" class="btn" onclick="showSection('citas')">Ver todas</a>
                </div>
                {% if recent_appointments %}
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in recent_appointments %}
                        <tr>
                            <td>{{ row.Appointment.pet_name }}</td>
                            <td>{{ row.Owner.name or row.Owner.phone_number }}</td>
                            <td>{{ row.Appointment.date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td><span style="color: var(--success);">Confirmado</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align: center; color: var(--text-dim); padding: 2rem;">No hay citas registradas a√∫n.</p>
                {% endif %}
            </div>
        </div>

        <!-- SECTION: CITAS -->
        <div id="section-citas" class="content-section" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <h2>Calendario de Citas</h2>
                    <button class="btn" style="background: var(--success);">+ Nueva Cita</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Motivo</th>
                            <th>Fecha y Hora</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in all_appointments %}
                        <tr>
                            <td>{{ row.Appointment.pet_name }}</td>
                            <td>{{ row.Owner.name or row.Owner.phone_number }}</td>
                            <td>{{ row.Appointment.reason or 'Consulta General' }}</td>
                            <td>{{ row.Appointment.date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td><span style="color: var(--success);">Confirmado</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION: PACIENTES -->
        <div id="section-pacientes" class="content-section" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <h2>Gesti√≥n de Pacientes</h2>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" placeholder="Buscar paciente o due√±o..."
                            style="padding: 0.5rem 1rem; border-radius: 10px; width: 300px;">
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Raza / Especie</th>
                            <th>Edad / Peso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in patients %}
                        <tr>
                            <td>
                                <strong>{{ row.Patient.name }}</strong><br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">{{ row.Patient.sex or 'No
                                    especificado' }}</span>
                            </td>
                            <td>{{ row.Owner.name or 'S/N' }}<br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">{{ row.Owner.phone_number
                                    }}</span>
                            </td>
                            <td>{{ row.Patient.breed or row.Patient.species }}</td>
                            <td>
                                <span class="patient-age" data-birth="{{ row.Patient.birth_date }}"></span><br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">{{ row.Patient.weight or '--'
                                    }} kg</span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    {% if org.plan_type in ['pro', 'premium'] %}
                                    <a href="/admin/export_history/{{ row.Patient.id }}" class="btn"
                                        style="padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--primary);">üìú
                                        Historia</a>
                                    {% else %}
                                    <button class="btn"
                                        onclick="alert('La Historia Cl√≠nica Completa es una funci√≥n PRO. ¬°Mejora tu plan para activar!')"
                                        style="padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--text-dim); color: var(--text-dim) !important; opacity: 0.6; cursor: not-allowed;">üîí
                                        Historia</button>
                                    {% endif %}

                                    <a href="/admin/export_vaccines/{{ row.Patient.id }}" class="btn"
                                        style="padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--secondary);">üíâ
                                        Certificado</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h2>üîë Cambiar Contrase√±a</h2>
            <div class="form-group">
                <label>Contrase√±a Actual</label>
                <input type="password" id="oldPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <label>Nueva Contrase√±a</label>
                <input type="password" id="newPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn" style="flex: 1;" onclick="submitPasswordChange()">Guardar</button>
                <button class="btn" style="flex: 1; background: var(--text-dim);"
                    onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        function showSection(sectionId, element) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            // Show target section
            document.getElementById('section-' + sectionId).style.display = 'block';

            // Update active state in sidebar
            if (element) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // Helper to calculate age
        function calculateAge(birthDate) {
            if (!birthDate || birthDate === 'None') return 'N/A';
            const birth = new Date(birthDate);
            const now = new Date();
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            if (months < 0 || (months === 0 && now.getDate() < birth.getDate())) {
                years--;
                months += 12;
            }
            if (years > 0) return years + (years === 1 ? ' a√±o' : ' a√±os');
            return months + (months === 1 ? ' mes' : ' meses');
        }

        function updateAges() {
            document.querySelectorAll('.patient-age').forEach(span => {
                const birth = span.getAttribute('data-birth');
                span.innerText = calculateAge(birth);
            });
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        async function submitPasswordChange() {
            const old_password = document.getElementById('oldPass').value;
            const new_password = document.getElementById('newPass').value;
            if (!old_password || !new_password) return alert('Ingresa ambas contrase√±as');

            const res = await fetch('/admin/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_password, new_password })
            });

            if (res.ok) {
                alert('¬°Contrase√±a actualizada con √©xito!');
                closePasswordModal();
            } else {
                const err = await res.json();
                alert('Error: ' + (err.detail || 'No se pudo actualizar la contrase√±a.'));
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isLight = body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeUI(isLight);
        }

        function updateThemeUI(isLight) {
            const text = document.getElementById('theme-text');
            const icon = document.getElementById('theme-icon');
            if (isLight) {
                text.innerText = 'Modo Oscuro';
                icon.innerText = 'üåô';
            } else {
                text.innerText = 'Modo Claro';
                icon.innerText = 'üåû';
            }
        }

        // Initialize
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                updateThemeUI(true);
            }
            updateAges();
        })();
    </script>
</body>

</html>