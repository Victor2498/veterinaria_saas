<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - {{ org.name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --border: rgba(255, 255, 255, 0.05);
            --sidebar-hover: rgba(99, 102, 241, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body.light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-dim: #64748b;
            --border: rgba(0, 0, 0, 0.05);
            --sidebar-hover: rgba(99, 102, 241, 0.05);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 1rem;
            border-radius: 12px;
            color: var(--text-dim);
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active,
        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--primary);
        }

        /* Theme Toggle */
        .theme-toggle {
            margin-top: 1rem;
            background: var(--sidebar-hover);
            padding: 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-dim);
            cursor: pointer;
            border: 1px solid var(--border);
        }

        .theme-toggle:hover {
            border-color: var(--primary-light);
            color: var(--text-main);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .tag {
            padding: 0.4rem 1rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tag-pro {
            background: linear-gradient(135deg, var(--secondary), #f43f5e);
            color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .tag-basic {
            background: var(--sidebar-hover);
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: var(--card-shadow);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--text-main);
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Table Section */
        .section-card {
            background: var(--card);
            border-radius: 24px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-dim);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn {
            background: var(--primary);
            color: white !important;
            padding: 0.6rem 1.2rem;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.3s;
            display: inline-block;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* Tabs styling */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            background: var(--sidebar-hover);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Detail List Styling */
        .detail-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .status-waiting {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .status-attended {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: #10b981;
        }

        .status-cancelled {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border-color: #f43f5e;
        }

        .status-confirmed {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-color: #6366f1;
        }

        .status-select {
            background: var(--bg);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            outline: none;
            cursor: pointer;
        }

        /* Modal Base */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 28px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            outline: none;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">üêæ DogBot Admin</div>
        <a href="#" class="nav-item active" onclick="showSection('dashboard', this)">üìä Dashboard</a>
        <a href="#" class="nav-item" onclick="showSection('citas', this)">üóìÔ∏è Citas</a>
        <a href="#" class="nav-item" onclick="showSection('pacientes', this)">üê∂ Pacientes</a>

        <div style="margin-top: auto;">
            <a href="/admin/subscription" class="nav-item">üíé Suscripci√≥n</a>
            <a href="#" class="nav-item" onclick="openPasswordModal()">‚öôÔ∏è Configuraci√≥n</a>
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-text">Modo Claro</span>
                <span id="theme-icon">üåû</span>
            </div>
            <a href="/logout" class="nav-item" style="color: #f43f5e;">üö™ Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="main">
        <!-- Header Dynamic? No, header is global -->
        <div class="header">
            <div>
                <h1 style="font-size: 1.8rem;">Bienvenido, {{ username }}</h1>
                <p style="color: var(--text-dim)">Gestionando Cl√≠nica: <strong>{{ org.name }}</strong></p>
            </div>
            <div class="tag {% if org.plan_type == 'pro' %}tag-pro{% else %}tag-basic{% endif %}">
                Plan {{ org.plan_type }}
            </div>
        </div>

        <!-- SECTION: DASHBOARD -->
        <div id="section-dashboard" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Citas Totales</div>
                    <div class="stat-value">{{ all_appointments|length }}</div>
                    <div style="color: var(--success); font-size: 0.8rem;">‚Üë 12% este mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pacientes Activos</div>
                    <div class="stat-value">{{ patients_count }}</div>
                    <div style="color: var(--primary-light); font-size: 0.8rem;">Base de datos completa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">WhatsApp Status</div>
                    <div class="stat-value" style="color: var(--success); font-size: 1.2rem;">üü¢ Conectado</div>
                    <div style="color: var(--text-dim); font-size: 0.8rem;">Instancia: {{ org.evolution_instance }}
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h2>Citas Recientes (WhatsApp)</h2>
                    <a href="#" class="btn" onclick="showSection('citas')">Ver todas</a>
                </div>
                {% if recent_appointments %}
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in recent_appointments %}
                        <tr>
                            <td><strong style="cursor: pointer; color: var(--primary);"
                                    onclick="navigateToPatient('{{ row.Patient.id if row.Patient else '' }}', '{{ row.Appointment.pet_name }}')">
                                    {{ row.Appointment.pet_name }}</strong></td>
                            <td>{{ row.Owner.name or row.Owner.phone_number }}</td>
                            <td>{{ row.Appointment.date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <select class="status-select status-{{ row.Appointment.status }}"
                                    onchange="updateAppointmentStatus('{{ row.Appointment.id }}', this.value)">
                                    <option value="confirmed" {% if row.Appointment.status=='confirmed' %}selected{%
                                        endif %}>Confirmado</option>
                                    <option value="waiting" {% if row.Appointment.status=='waiting' %}selected{% endif
                                        %}>En espera</option>
                                    <option value="attended" {% if row.Appointment.status=='attended' %}selected{% endif
                                        %}>Atendido</option>
                                    <option value="cancelled" {% if row.Appointment.status=='cancelled' %}selected{%
                                        endif %}>Suspendido</option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align: center; color: var(--text-dim); padding: 2rem;">No hay citas registradas a√∫n.</p>
                {% endif %}
            </div>
        </div>

        <!-- SECTION: CITAS -->
        <div id="section-citas" class="content-section" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <h2>Calendario de Citas</h2>
                    <button class="btn" style="background: var(--success);">+ Nueva Cita</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Motivo</th>
                            <th>Fecha y Hora</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in all_appointments %}
                        <tr>
                            <td><strong style="cursor: pointer; color: var(--primary);"
                                    onclick="navigateToPatient('{{ row.Patient.id if row.Patient else '' }}', '{{ row.Appointment.pet_name }}')">
                                    {{ row.Appointment.pet_name }}</strong></td>
                            <td>{{ row.Owner.name or row.Owner.phone_number }}</td>
                            <td>{{ row.Appointment.reason or 'Consulta General' }}</td>
                            <td>{{ row.Appointment.date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <select class="status-select status-{{ row.Appointment.status }}"
                                    onchange="updateAppointmentStatus('{{ row.Appointment.id }}', this.value)">
                                    <option value="confirmed" {% if row.Appointment.status=='confirmed' %}selected{%
                                        endif %}>Confirmado</option>
                                    <option value="waiting" {% if row.Appointment.status=='waiting' %}selected{% endif
                                        %}>En espera</option>
                                    <option value="attended" {% if row.Appointment.status=='attended' %}selected{% endif
                                        %}>Atendido</option>
                                    <option value="cancelled" {% if row.Appointment.status=='cancelled' %}selected{%
                                        endif %}>Suspendido</option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION: PACIENTES -->
        <div id="section-pacientes" class="content-section" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <h2>Gesti√≥n de Pacientes</h2>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" placeholder="Buscar paciente o due√±o..."
                            style="padding: 0.5rem 1rem; border-radius: 10px; width: 300px;">
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Due√±o</th>
                            <th>Raza / Especie</th>
                            <th>Edad / Peso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in patients %}
                        <tr>
                            <td>
                                <strong style="cursor: pointer; color: var(--primary);"
                                    onclick="openEditPatientModal('{{ row.Patient.id }}')">
                                    {{ row.Patient.name }}</strong><br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">{{ row.Patient.sex or 'No
                                    especificado' }}</span>
                            </td>
                            <td>{{ row.Owner.name or 'S/N' }}<br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">{{ row.Owner.phone_number
                                    }}</span>
                            </td>
                            <td>{{ row.Patient.breed or row.Patient.species }}</td>
                            <td>
                                <span class="patient-age" data-birth="{{ row.Patient.birth_date }}"></span><br>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">
                                    {{ row.Patient.weight or '--' }} kg / {{ row.Patient.height or '--' }} cm
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">


                                    <button class="btn"
                                        style="padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--primary-light); color: var(--primary-light) !important;"
                                        onclick="openEditPatientModal('{{ row.Patient.id }}')">
                                        üëÅÔ∏è Ver Detalle</button>

                                    <button class="btn"
                                        style="padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid #f43f5e; color: #f43f5e !important;"
                                        onclick="deletePatient('{{ row.Patient.id }}', '{{ row.Patient.name }}')">
                                        üóëÔ∏è Eliminar</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h2>üîë Cambiar Contrase√±a</h2>
            <div class="form-group">
                <label>Contrase√±a Actual</label>
                <input type="password" id="oldPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <label>Nueva Contrase√±a</label>
                <input type="password" id="newPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn" style="flex: 1;" onclick="submitPasswordChange()">Guardar</button>
                <button class="btn" style="flex: 1; background: var(--bg); color: var(--text-dim) !important;"
                    onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Detailed Patient Modal (Tabs) -->
    <div id="patientEditModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="modalTitle">Detalle del Paciente</h2>
                <button onclick="closeEditPatientModal()"
                    style="background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:1.5rem;">&times;</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tab-general', this)">üìã Datos</button>
                <button class="tab-btn" onclick="switchTab('tab-historia', this)">üìú Historia</button>
                <button class="tab-btn" onclick="switchTab('tab-vacunas', this)">üíâ Vacunas</button>
            </div>

            <!-- Tab: General -->
            <div id="tab-general" class="tab-content active">
                <input type="hidden" id="editPatId">
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nombre</label>
                        <input type="text" id="editPatName">
                    </div>
                    <div class="form-group">
                        <label>Especie</label>
                        <input type="text" id="editPatSpecies">
                    </div>
                    <div class="form-group">
                        <label>Raza</label>
                        <input type="text" id="editPatBreed">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" id="editPatBirth">
                    </div>
                    <div class="form-group">
                        <label>Sexo</label>
                        <select id="editPatSex"
                            style="width: 100%; padding: 0.75rem; border-radius: 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text-main); outline: none;">
                            <option value="Macho">Macho</option>
                            <option value="Hembra">Hembra</option>
                            <option value="No especificado">No especificado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" step="0.1" id="editPatWeight">
                    </div>
                    <div class="form-group">
                        <label>Altura (cm)</label>
                        <input type="number" step="0.1" id="editPatHeight">
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn" style="width: 100%;" onclick="savePatientEdit()">Guardar Cambios
                        Principales</button>
                </div>
            </div>

            <!-- Tab: Historia Cl√≠nica -->
            <div id="tab-historia" class="tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center;">
                    <h3>Evoluci√≥n M√©dica</h3>
                    <button class="btn" style="padding: 0.4rem 0.8rem; background: var(--success);"
                        onclick="showNewRecordForm()">+ Nueva</button>
                </div>

                <div id="new-record-form"
                    style="display:none; background: var(--sidebar-hover); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--primary);">
                    <textarea id="new-record-desc" placeholder="Describe la evoluci√≥n, diagn√≥stico o tratamiento..."
                        style="width:100%; height:80px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:8px; padding:0.5rem; outline:none; margin-bottom:0.5rem;"></textarea>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn" style="flex:1; font-size:0.8rem;" onclick="submitNewRecord()">Guardar
                            Registro</button>
                        <button class="btn"
                            style="flex:1; font-size:0.8rem; background:var(--bg); border:1px solid var(--border);"
                            onclick="hideNewRecordForm()">Cancelar</button>
                    </div>
                </div>

                <div id="history-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Se llena con JS -->
                </div>

                <div style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    {% if org.plan_type == 'pro' or org.plan_type == 'premium' %}
                    <button class="btn" style="width: 100%; background: var(--card); border: 1px solid var(--primary);"
                        id="btnExportHistory">üìú Descargar Historia Cl√≠nica (PDF)</button>
                    {% else %}
                    <button class="btn"
                        style="width: 100%; background: var(--card); border: 1px solid var(--text-dim); opacity: 0.6; cursor: not-allowed;"
                        onclick="alert('Mejora a PRO para descargar PDFs')">üîí PDF bloqueado (Plan {{
                        org.plan_type.upper() }})</button>
                    {% endif %}
                </div>
            </div>

            <!-- Tab: Vacunas -->
            <div id="tab-vacunas" class="tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center;">
                    <h3>Plan de Vacunaci√≥n</h3>
                    <button class="btn" style="padding: 0.4rem 0.8rem; background: var(--primary-light);"
                        onclick="showNewVacForm()">+ Registrar</button>
                </div>

                <div id="new-vac-form"
                    style="display:none; background: var(--sidebar-hover); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--primary-light);">
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <input type="text" id="new-vac-name" placeholder="Nombre de vacuna (ej: Sextuple)">
                        <input type="date" id="new-vac-next" title="Pr√≥xima dosis (opcional)">
                    </div>
                    <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                        <button class="btn" style="flex:1; font-size:0.8rem;" onclick="submitNewVac()">Confirmar
                            Aplicaci√≥n</button>
                        <button class="btn"
                            style="flex:1; font-size:0.8rem; background:var(--bg); border:1px solid var(--border);"
                            onclick="hideNewVacForm()">Cancelar</button>
                    </div>
                </div>

                <table id="vaccine-table">
                    <thead>
                        <tr>
                            <th>Vacuna</th>
                            <th>Fecha</th>
                            <th>Sig. Dosis</th>
                        </tr>
                    </thead>
                    <tbody id="vaccine-list">
                        <!-- Se llena con JS -->
                    </tbody>
                </table>

                <div style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    {% if org.plan_type == 'pro' or org.plan_type == 'premium' %}
                    <button class="btn"
                        style="width: 100%; background: var(--card); border: 1px solid var(--primary-light);"
                        id="btnExportVac">üíâ Descargar Certificado (PDF)</button>
                    {% else %}
                    <button class="btn"
                        style="width: 100%; background: var(--card); border: 1px solid var(--text-dim); opacity: 0.6; cursor: not-allowed;"
                        onclick="alert('Mejora a PRO para descargar Certificados')">üîí PDF bloqueado (Plan {{
                        org.plan_type.upper() }})</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function showSection(sectionId, element) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            // Show target section
            document.getElementById('section-' + sectionId).style.display = 'block';

            // Update active state in sidebar
            if (element) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // Helper to calculate age
        function calculateAge(birthDate) {
            if (!birthDate || birthDate === 'None') return 'N/A';
            const birth = new Date(birthDate);
            const now = new Date();
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            if (months < 0 || (months === 0 && now.getDate() < birth.getDate())) {
                years--;
                months += 12;
            }
            if (years > 0) return years + (years === 1 ? ' a√±o' : ' a√±os');
            return months + (months === 1 ? ' mes' : ' meses');
        }

        function updateAges() {
            document.querySelectorAll('.patient-age').forEach(span => {
                const birth = span.getAttribute('data-birth');
                span.innerText = calculateAge(birth);
            });
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        async function submitPasswordChange() {
            const old_password = document.getElementById('oldPass').value;
            const new_password = document.getElementById('newPass').value;
            if (!old_password || !new_password) return alert('Ingresa ambas contrase√±as');

            const res = await fetch('/admin/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_password, new_password })
            });

            if (res.ok) {
                alert('¬°Contrase√±a actualizada con √©xito!');
                closePasswordModal();
            } else {
                const err = await res.json();
                alert('Error: ' + (err.detail || 'No se pudo actualizar la contrase√±a.'));
            }
        }

        // --- Patient Detail & Tabs Logic ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
        }

        async function openEditPatientModal(id) {
            // Load base data from API
            const res = await fetch(`/admin/patient_data/${id}`);
            if (!res.ok) return alert("Error al cargar datos del paciente");

            const data = await res.json();
            const p = data.patient;

            document.getElementById('editPatId').value = p.id;
            document.getElementById('modalTitle').innerText = `Detalle: ${p.name}`;
            document.getElementById('editPatName').value = p.name;
            document.getElementById('editPatSpecies').value = p.species;
            document.getElementById('editPatBreed').value = p.breed || '';
            document.getElementById('editPatBirth').value = p.birth_date || '';
            document.getElementById('editPatWeight').value = p.weight || '';
            document.getElementById('editPatHeight').value = p.height || '';
            document.getElementById('editPatSex').value = p.sex || 'No especificado';

            // Populate Clinical History
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = data.records.length ? '' : '<p style="color:var(--text-dim); padding:1rem;">No hay registros a√∫n.</p>';
            data.records.forEach(r => {
                const item = document.createElement('div');
                item.className = 'detail-item';
                item.innerHTML = `
                    <div class="detail-header">
                        <span>üìÖ ${r.date}</span>
                        <span>üë®‚Äç‚öïÔ∏è ${r.vet_name}</span>
                    </div>
                    <div style="font-size:0.95rem; margin-bottom:0.5rem;">${r.description}</div>
                    <div style="text-align:right;">
                        <button class="btn" style="font-size:0.7rem; padding:0.2rem 0.5rem; background:transparent; border:1px solid var(--border); color:var(--text-dim) !important;" 
                            onclick="editClinicalRecord(${r.id}, '${r.description.replace(/'/g, "\\'")}')">‚úèÔ∏è Editar</button>
                    </div>
                `;
                historyList.appendChild(item);
            });

            // Populate Vaccinations
            const vaccineList = document.getElementById('vaccine-list');
            vaccineList.innerHTML = data.vaccinations.length ? '' : '<tr><td colspan="4" style="text-align:center; color:var(--text-dim);">Sin vacunas registradas</td></tr>';
            data.vaccinations.forEach(v => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${v.vaccine_name}</strong></td>
                    <td>${v.date}</td>
                    <td><span class="badge" style="background:var(--sidebar-hover); color:var(--primary);">${v.next_dose}</span></td>
                    <td style="text-align:right;">
                        <button onclick="editVaccination(${v.id}, '${v.vaccine_name}', '${v.next_dose}')" style="background:none; border:none; cursor:pointer;">‚úèÔ∏è</button>
                    </td>
                `;
                vaccineList.appendChild(row);
            });

            // Set PDF links
            const btnHistory = document.getElementById('btnExportHistory');
            if (btnHistory) btnHistory.onclick = () => window.open(`/admin/export_history/${p.id}`, '_blank');

            const btnVac = document.getElementById('btnExportVac');
            if (btnVac) btnVac.onclick = () => window.open(`/admin/export_vaccines/${p.id}`, '_blank');

            // Reset tabs
            switchTab('tab-general', document.querySelector('.tab-btn'));
            document.getElementById('patientEditModal').style.display = 'flex';
        }

        function showNewRecordForm() { document.getElementById('new-record-form').style.display = 'block'; }
        function hideNewRecordForm() { document.getElementById('new-record-form').style.display = 'none'; }

        async function submitNewRecord() {
            const description = document.getElementById('new-record-desc').value;
            const patient_id = document.getElementById('editPatId').value;
            if (!description) return alert("Escribe un detalle cl√≠nico");

            const res = await fetch('/admin/add_clinical_record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patient_id, description })
            });

            if (res.ok) {
                document.getElementById('new-record-desc').value = '';
                hideNewRecordForm();
                openEditPatientModal(patient_id); // Refresh
            }
        }

        function showNewVacForm() { document.getElementById('new-vac-form').style.display = 'block'; }
        function hideNewVacForm() { document.getElementById('new-vac-form').style.display = 'none'; }

        async function submitNewVac() {
            const vaccine_name = document.getElementById('new-vac-name').value;
            const next_dose_date = document.getElementById('new-vac-next').value;
            const patient_id = document.getElementById('editPatId').value;
            if (!vaccine_name) return alert("Indica el nombre de la vacuna");

            const res = await fetch('/admin/add_vaccination', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patient_id, vaccine_name, next_dose_date })
            });

            if (res.ok) {
                document.getElementById('new-vac-name').value = '';
                document.getElementById('new-vac-next').value = '';
                hideNewVacForm();
                openEditPatientModal(patient_id); // Refresh
            }
        }

        async function editClinicalRecord(id, oldDesc) {
            const newDesc = prompt("Editar evoluci√≥n cl√≠nica:", oldDesc);
            if (newDesc === null || newDesc === oldDesc) return;

            const res = await fetch(`/admin/update_clinical_record/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: newDesc })
            });
            if (res.ok) openEditPatientModal(document.getElementById('editPatId').value);
        }

        async function editVaccination(id, oldName, oldNext) {
            const newName = prompt("Nombre de la vacuna:", oldName);
            if (newName === null) return;
            const nextStr = oldNext !== 'N/A' ? oldNext.split('/').reverse().join('-') : '';
            const newNext = prompt("Pr√≥xima dosis (AAAA-MM-DD):", nextStr);
            if (newNext === null) return;

            const res = await fetch(`/admin/update_vaccination/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vaccine_name: newName, next_dose_date: newNext })
            });
            if (res.ok) openEditPatientModal(document.getElementById('editPatId').value);
        }

        function closeEditPatientModal() {
            document.getElementById('patientEditModal').style.display = 'none';
        }

        async function savePatientEdit() {
            const id = document.getElementById('editPatId').value;
            const data = {
                name: document.getElementById('editPatName').value,
                species: document.getElementById('editPatSpecies').value,
                breed: document.getElementById('editPatBreed').value,
                birth_date: document.getElementById('editPatBirth').value,
                weight: document.getElementById('editPatWeight').value,
                height: document.getElementById('editPatHeight').value,
                sex: document.getElementById('editPatSex').value
            };

            const res = await fetch(`/admin/update_patient/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('¬°Paciente actualizado!');
                location.reload();
            } else {
                alert('Error al guardar cambios.');
            }
        }

        function navigateToPatient(id, name) {
            showSection('pacientes', document.querySelector('a[onclick*="pacientes"]'));
            if (id) {
                // Si tenemos el ID, abrimos el modal directamente
                // Necesitar√≠amos buscar los datos o pasarlos. Para simplificar, 
                // si viene de otra secci√≥n donde no tenemos todo, podemos buscar la fila o simplemente filtrar.
                const searchInput = document.querySelector('#section-pacientes input[type="text"]');
                if (searchInput) {
                    searchInput.value = name;
                    // Opcional: disparar evento de b√∫squeda si lo implementas
                }
            }
        }

        async function updateAppointmentStatus(id, newStatus) {
            const res = await fetch(`/admin/update_appointment_status/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.ok) {
                // Success - the class will be updated on reload, 
                // but we can update it immediately for better UX
                location.reload();
            } else {
                alert('Error al actualizar el estado de la cita');
            }
        }

        async function deletePatient(id, name) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar permanentemente a "${name}"? Se borrar√°n tambi√©n todos sus registros m√©dicos y vacunas.`)) {
                return;
            }

            const res = await fetch(`/admin/delete_patient/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert('Paciente eliminado correctamente');
                location.reload();
            } else {
                const err = await res.json();
                alert('Error: ' + (err.detail || 'No se pudo eliminar al paciente.'));
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isLight = body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeUI(isLight);
        }

        function updateThemeUI(isLight) {
            const text = document.getElementById('theme-text');
            const icon = document.getElementById('theme-icon');
            if (isLight) {
                text.innerText = 'Modo Oscuro';
                icon.innerText = 'üåô';
            } else {
                text.innerText = 'Modo Claro';
                icon.innerText = 'üåû';
            }
        }

        // Initialize
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                updateThemeUI(true);
            }
            updateAges();
        })();
    </script>
</body>

</html>